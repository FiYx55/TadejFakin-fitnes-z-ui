<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Fitnes_ai.ViewModels"
             xmlns:local="clr-namespace:Fitnes_ai.Converters"
             x:Class="Fitnes_ai.Views.PlanSelectionPage"
             Title="Workout Plans"
             BackgroundColor="{DynamicResource BackgroundColor}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <local:ActivePlanConverter x:Key="ActivePlanConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header with Active Plan Info -->
        <StackLayout Grid.Row="0" BackgroundColor="{StaticResource Primary}" Padding="20,15,20,20">
            <Label Text="Currently Active Plan" 
                   FontSize="16" 
                   TextColor="White" 
                   FontAttributes="Bold" />
            <Label Text="{Binding ActivePlanName}" 
                   FontSize="20" 
                   TextColor="White" 
                   FontAttributes="Bold" />
            <Label Text="Select a different plan below to switch" 
                   FontSize="14" 
                   TextColor="#B4FFFFFF" />
        </StackLayout>

        <!-- Plans List -->
        <CollectionView Grid.Row="1" 
                        ItemsSource="{Binding Plans}"
                        BackgroundColor="White"
                        IsVisible="{Binding HasPlans}">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Grid Padding="20,15" BackgroundColor="White">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <!-- Plan Info -->
                        <StackLayout Grid.Row="0" Grid.Column="0" Grid.RowSpan="2" VerticalOptions="Center">
                            <StackLayout.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:PlanSelectionViewModel}}, Path=SelectPlanCommand}"
                                                      CommandParameter="{Binding}" />
                            </StackLayout.GestureRecognizers>
                            
                            <Label Text="{Binding Name}"
                                   FontSize="18"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Gray900}" />
                            <Label Text="Tap to select this plan"
                                   FontSize="14"
                                   TextColor="{StaticResource Gray500}" />
                        </StackLayout>

                        <!-- Active Plan Indicator -->
                        <Frame Grid.Row="0" Grid.Column="1"
                               BackgroundColor="#E8F4FD"
                               BorderColor="{StaticResource Primary}"
                               CornerRadius="12"
                               Padding="8,4"
                               HasShadow="False"
                               HorizontalOptions="Center"
                               VerticalOptions="Center">
                            <Frame.IsVisible>
                                <MultiBinding Converter="{StaticResource ActivePlanConverter}">
                                    <Binding Path="Id" />
                                    <Binding Path="ActivePlan.Id" Source="{RelativeSource AncestorType={x:Type viewmodels:PlanSelectionViewModel}}" />
                                </MultiBinding>
                            </Frame.IsVisible>
                            <Label Text="âœ“ ACTIVE"
                                   FontSize="12"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Primary}" />
                        </Frame>

                        <!-- Delete Button -->
                        <Button Grid.Row="0" Grid.Column="2"
                                Text="âœ•"
                                BackgroundColor="#FFEBEE"
                                TextColor="#D32F2F"
                                FontSize="18"
                                FontAttributes="Bold"
                                WidthRequest="44"
                                HeightRequest="44"
                                CornerRadius="22"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:PlanSelectionViewModel}}, Path=DeletePlanCommand}"
                                CommandParameter="{Binding}" />

                        <!-- Separator Line -->
                        <BoxView Grid.Row="1" Grid.ColumnSpan="3" 
                                 Color="{StaticResource Gray200}" 
                                 HeightRequest="1" 
                                 Margin="0,15,0,0" />
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Empty State -->
        <Grid Grid.Row="1" 
              BackgroundColor="White"
              IsVisible="{Binding HasNoPlans}">
            <StackLayout VerticalOptions="Center" 
                         HorizontalOptions="Center" 
                         Spacing="20">
                <Label Text="ðŸ“‹"
                       FontSize="64"
                       HorizontalOptions="Center" />
                <Label Text="No workout plans yet"
                       FontSize="20"
                       FontAttributes="Bold"
                       TextColor="{StaticResource Gray900}"
                       HorizontalOptions="Center" />
                <Label Text="Create your first workout plan to get started"
                       FontSize="16"
                       TextColor="{StaticResource Gray500}"
                       HorizontalOptions="Center" />
            </StackLayout>
        </Grid>

        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="1" 
                          IsRunning="{Binding IsLoading}" 
                          IsVisible="{Binding IsLoading}"
                          Color="{StaticResource Primary}"
                          VerticalOptions="Center" 
                          HorizontalOptions="Center" />

        <!-- Action Button -->
        <StackLayout Grid.Row="2" Padding="20,15,20,20" BackgroundColor="White">
            <Button Text="+ Create New Plan"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    CornerRadius="25"
                    FontSize="16"
                    FontAttributes="Bold"
                    HeightRequest="50"
                    HorizontalOptions="Fill"
                    Command="{Binding CreatePlanCommand}" />
        </StackLayout>
    </Grid>
</ContentPage>
